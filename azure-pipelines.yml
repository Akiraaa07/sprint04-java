trigger:
  branches:
    include:
      - main
      - master
      - release

pool:
  vmImage: 'ubuntu-latest'

variables:
  rm: rm554227
  resourceGroup: rg-webapp-sprint4
  servicePlan: plan-webapp-sprint4
  appName: webapp-sprint4-linux
  location: eastus2
  runtime: JAVA:17-java17
  artifactName: sprint04

stages:
  - stage: CriarInfra
    jobs:
      - job: infraestrutura
        steps:
          - script: echo "Infraestrutura já provisionada manualmente. Nenhuma ação necessária aqui."

  - stage: Build
    dependsOn: CriarInfra
    jobs:
      - job: build
        steps:
          - script: |
              chmod +x gradlew
              ./gradlew build --stacktrace --info
            displayName: 'Build com Gradle wrapper'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)/build/libs'
              Contents: '*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: $(artifactName)

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: deploy
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: current
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(System.ArtifactsDirectory)/$(artifactName)'
              Contents: '*.jar'
              TargetFolder: '$(System.DefaultWorkingDirectory)'

          - task: AzureWebApp@1
            inputs:
              azureSubscription: 'MyAzureSubscription'
              appType: webAppLinux
              appName: $(appName)
              package: '$(System.DefaultWorkingDirectory)/sprint04-0.0.1-SNAPSHOT.jar'
